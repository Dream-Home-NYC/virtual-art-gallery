<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Critical: Force no-referrer to allow access to Museum CDNs which block hotlinking -->
    <meta name="referrer" content="no-referrer">
    <title>Virtual Art Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400&display=swap');

        body {
            background-color: #000;
            color: #e5e5e5;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
            margin: 0;
        }

        h1, .artwork-title {
            font-family: 'Playfair Display', serif;
        }

        .art-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
            background-color: #000;
            overflow: hidden;
            /* Reduced padding to allow the artwork to occupy 30% more space */
            padding: 60px 4vw 80px 4vw;
            box-sizing: border-box;
        }

        .artwork-image {
            /* Fills the container safe area */
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            box-shadow: 0 0 100px rgba(0, 0, 0, 0.8);
            transition: opacity 1.8s ease-in-out, transform 1.8s ease-in-out;
            opacity: 0;
            transform: scale(1.1); 
        }

        .artwork-image.active {
            opacity: 1;
            /* Scale increased to 1.3 to make it 30% bigger than its container fit */
            transform: scale(1.3);
        }

        .info-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 50;
            transition: opacity 1.2s ease-in-out;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.4) 50%, transparent 100%);
            padding: 80px 3vw 40px 3vw;
            opacity: 0;
            pointer-events: none;
        }

        .progress-bar-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255,255,255,0.02);
            z-index: 60;
        }

        #progress-fill {
            height: 100%;
            width: 0%;
            background: #d4af37;
            transition: width 1s linear;
        }

        .nav-btn {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 12px;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
        }

        .nav-btn:hover {
            opacity: 1;
            background: rgba(212, 175, 55, 0.4);
            transform: scale(1.1);
            border-color: rgba(212, 175, 55, 0.6);
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(0,0,0,0.95) 100%);
            pointer-events: none;
            z-index: 5;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255,255,255,0.15);
            transition: .4s;
            border-radius: 20px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 14px; width: 14px;
            left: 3px; bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #d4af37; }
        input:checked + .slider:before { transform: translateX(18px); }

        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            display: none;
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(212, 175, 55, 0.1);
            border-top: 2px solid #d4af37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #error-toast {
            position: fixed;
            top: 15px;
            right: 15px;
            background: rgba(153, 27, 27, 0.95);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 1000;
            font-size: 0.75rem;
            transform: translateY(-120px);
            transition: transform 0.4s ease;
        }
        #error-toast.visible { transform: translateY(0); }
    </style>
</head>
<body>

    <div class="vignette"></div>
    <div id="error-toast">Connection issue. Retrying...</div>

    <audio id="bg-music" loop>
        <source src="https://upload.wikimedia.org/wikipedia/commons/b/be/Clair_de_lune_%28Claude_Debussy%29_Suite_bergamasque.ogg" type="audio/ogg">
    </audio>

    <header class="fixed top-0 left-0 w-full p-6 flex justify-between items-center z-50 pointer-events-none">
        <div class="flex items-center gap-3 pointer-events-auto">
            <div class="w-0.5 h-5 bg-yellow-600"></div>
            <div>
                <h1 class="text-lg tracking-widest font-light opacity-60">VIRTUAL GALLERY</h1>
            </div>
        </div>
        
        <div class="flex items-center gap-4 bg-black/60 backdrop-blur-md p-2 px-4 rounded-full border border-white/10 pointer-events-auto shadow-2xl">
            <div class="flex items-center gap-3 px-1">
                <span class="text-[8px] uppercase tracking-wider opacity-40">Curated</span>
                <label class="switch">
                    <input type="checkbox" id="mode-toggle" onchange="toggleMode()">
                    <span class="slider"></span>
                </label>
                <span class="text-[8px] uppercase tracking-wider opacity-40">Discovery</span>
            </div>
            <div class="hidden md:block text-[8px] tracking-widest opacity-30 border-l border-white/20 pl-4 font-mono" id="timer-label">
                5:00
            </div>
        </div>
    </header>

    <main class="art-container" id="gallery">
        <div id="loading-indicator">
            <div class="spinner"></div>
        </div>
        <img id="artwork" src="" alt="Famous Artwork" class="artwork-image" referrerpolicy="no-referrer">
        
        <div class="info-overlay" id="info">
            <h2 class="artwork-title text-xl md:text-2xl mb-1 italic leading-snug text-white/90 font-normal" id="title">Loading...</h2>
            <div class="flex flex-wrap items-baseline gap-x-3">
                <p class="text-base text-gray-400 font-light" id="artist"></p>
                <p class="text-[9px] tracking-[0.2em] uppercase opacity-30 font-semibold" id="year"></p>
            </div>
        </div>
    </main>

    <div class="fixed right-5 bottom-8 flex items-center gap-2 z-50">
        <button id="audio-btn" class="nav-btn" onclick="toggleAudio()" title="Audio Guide">
            <svg id="audio-on-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
            <svg id="audio-off-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        </button>

        <button class="nav-btn" onclick="previousArt()" id="prev-btn" title="Previous">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
        </button>
        <button class="nav-btn" onclick="nextArt()" title="Next">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
        </button>
        <button class="nav-btn" onclick="toggleFullscreen()" title="Fullscreen">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/><path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/></svg>
        </button>
    </div>

    <div class="progress-bar-container">
        <div id="progress-fill"></div>
    </div>

    <script>
        const curatedObjectIds = [
            436532, 11445, 10592, 436535, 437133, 436524, 436533, 336327, 
            435882, 438815, 435809, 436105, 437984, 437980, 436121, 435817,
            437397, 437396, 437869, 437879, 437881, 435739, 436545, 436504,
            436529, 436531, 436839, 436947, 437056, 437097, 437153, 437175,
            437198, 437202, 437299, 437326, 437329, 437430, 437447, 437455,
            437493, 437502, 437549, 437609, 437654, 437701, 437769, 437822,
            437826, 437835, 437891, 437926, 435621, 435702, 435812, 435868,
            435904, 435962, 436002, 436021, 436058, 436063, 436095, 436101
        ];

        let localArtworks = [];
        let apiObjectIds = [];
        let currentIndex = 0;
        let isApiMode = false;
        let isLoading = false;
        let consecutiveErrorCount = 0;
        const ROTATION_TIME = 5 * 60 * 1000; 
        let startTime = Date.now();
        let isAudioPlaying = false;

        const artImg = document.getElementById('artwork');
        const titleEl = document.getElementById('title');
        const artistEl = document.getElementById('artist');
        const yearEl = document.getElementById('year');
        const infoEl = document.getElementById('info');
        const progressFill = document.getElementById('progress-fill');
        const timerLabel = document.getElementById('timer-label');
        const loadingEl = document.getElementById('loading-indicator');
        const bgMusic = document.getElementById('bg-music');
        const errorToast = document.getElementById('error-toast');

        async function fetchWithRetry(url, options = {}, retries = 5, backoff = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (err) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, backoff));
                    return fetchWithRetry(url, options, retries - 1, backoff * 2);
                }
                throw err;
            }
        }

        async function initGallery() {
            loadingEl.style.display = 'block';
            try {
                const searchData = await fetchWithRetry('https://collectionapi.metmuseum.org/public/collection/v1/search?isHighlight=true&hasImages=true&q=painting');
                apiObjectIds = searchData.objectIDs || [];
                const initialBatchIds = curatedObjectIds.slice(0, 10);
                await fetchBatch(initialBatchIds);
                updateGallery();
                setInterval(updateProgress, 1000);
                fetchRemainingData();
            } catch (e) { 
                console.error("Init Error:", e);
                showToast("Archive link unstable. Retrying...");
            }
        }

        async function fetchBatch(ids) {
            const promises = ids.map(id => fetchWithRetry(`https://collectionapi.metmuseum.org/public/collection/v1/objects/${id}`).catch(() => null));
            const results = await Promise.all(promises);
            results.forEach(art => {
                if (art && (art.primaryImage || art.primaryImageSmall)) {
                    localArtworks.push({
                        title: art.title || "Untitled", artist: art.artistDisplayName || "Unknown Artist", year: art.objectDate || "N/A", url: art.primaryImageSmall || art.primaryImage
                    });
                }
            });
        }

        async function fetchRemainingData() {
            const remaining = curatedObjectIds.slice(10);
            for (let i = 0; i < remaining.length; i += 5) {
                await fetchBatch(remaining.slice(i, i + 5));
                await new Promise(r => setTimeout(r, 1000));
            }
            while (localArtworks.length < 500 && apiObjectIds.length > 0) {
                const randomIds = [];
                for(let j=0; j<10; j++) randomIds.push(apiObjectIds[Math.floor(Math.random() * apiObjectIds.length)]);
                await fetchBatch(randomIds);
                await new Promise(r => setTimeout(r, 3000));
            }
        }

        async function fetchDiscoveryArt() {
            if (isLoading || apiObjectIds.length === 0) return;
            isLoading = true;
            loadingEl.style.display = 'block';
            artImg.classList.remove('active');
            infoEl.style.opacity = '0';
            
            let attempts = 0;
            while (attempts < 8) {
                const randomId = apiObjectIds[Math.floor(Math.random() * apiObjectIds.length)];
                try {
                    const art = await fetchWithRetry(`https://collectionapi.metmuseum.org/public/collection/v1/objects/${randomId}`, {}, 2);
                    const url = art.primaryImageSmall || art.primaryImage;
                    if (url) {
                        renderArtwork({ title: art.title || "Untitled", artist: art.artistDisplayName || "Unknown Artist", year: art.objectDate || "N/A", url: url });
                        return;
                    }
                } catch (e) {}
                attempts++;
            }
            isLoading = false;
            toggleMode(false);
        }

        function renderArtwork(art) {
            const tempImg = new Image();
            tempImg.referrerPolicy = "no-referrer";
            tempImg.src = art.url;
            tempImg.onload = () => {
                consecutiveErrorCount = 0;
                artImg.src = art.url;
                titleEl.innerText = art.title;
                artistEl.innerText = art.artist;
                yearEl.innerText = art.year;
                loadingEl.style.display = 'none';
                artImg.classList.add('active');
                infoEl.style.opacity = '1';
                isLoading = false;
                startTime = Date.now();
            };
            tempImg.onerror = () => {
                consecutiveErrorCount++;
                if (!isApiMode) localArtworks = localArtworks.filter(item => item.url !== art.url);
                if (isApiMode) fetchDiscoveryArt();
                else nextArt();
            };
        }

        function updateGallery() {
            if (isApiMode) fetchDiscoveryArt();
            else if (localArtworks.length > 0) renderArtwork(localArtworks[currentIndex]);
        }

        function toggleMode(forcedState) {
            const toggle = document.getElementById('mode-toggle');
            if (forcedState !== undefined) toggle.checked = forcedState;
            isApiMode = toggle.checked;
            updateGallery();
        }

        function nextArt() {
            if (isLoading) return;
            if (isApiMode) updateGallery();
            else if (localArtworks.length > 0) {
                currentIndex = (currentIndex + 1) % localArtworks.length;
                updateGallery();
            }
        }

        function previousArt() {
            if (isLoading || isApiMode || localArtworks.length === 0) return;
            currentIndex = (currentIndex - 1 + localArtworks.length) % localArtworks.length;
            updateGallery();
        }

        function toggleAudio() {
            if (!isAudioPlaying) {
                bgMusic.play().catch(() => {});
                document.getElementById('audio-on-icon').classList.remove('hidden');
                document.getElementById('audio-off-icon').classList.add('hidden');
            } else {
                bgMusic.pause();
                document.getElementById('audio-on-icon').classList.add('hidden');
                document.getElementById('audio-off-icon').classList.remove('hidden');
            }
            isAudioPlaying = !isAudioPlaying;
        }

        function updateProgress() {
            if (isLoading) return;
            const elapsed = Date.now() - startTime;
            const remaining = Math.max(0, ROTATION_TIME - elapsed);
            progressFill.style.width = Math.min((elapsed / ROTATION_TIME) * 100, 100) + '%';
            const min = Math.floor(remaining / 60000);
            const sec = Math.floor((remaining % 60000) / 1000);
            timerLabel.innerText = `${min}:${sec.toString().padStart(2, '0')}`;
            if (elapsed >= ROTATION_TIME) nextArt();
        }

        function showToast(msg) {
            errorToast.innerText = msg;
            errorToast.classList.add('visible');
            setTimeout(() => errorToast.classList.remove('visible'), 5000);
        }

        async function toggleFullscreen() {
            try {
                if (!document.fullscreenElement) {
                    if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
                    else showToast("Fullscreen restricted.");
                } else {
                    if (document.exitFullscreen) await document.exitFullscreen();
                }
            } catch (err) { showToast("Fullscreen restricted."); }
        }

        window.onload = initGallery;
    </script>
</body>
</html>
